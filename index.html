<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web in Web (タブレット強力版)</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #f0f0f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .control-bar { background-color: #ffffff; padding: 10px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        #url-input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; outline: none; background-color: #f2f2f7; }
        #url-input:focus { background-color: #fff; border-color: #007aff; }
        
        button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: filter 0.2s; color: white; white-space: nowrap;}
        button:hover { filter: brightness(90%); }

        .btn-google { background-color: #4285F4; } 
        .btn-youtube { background-color: #FF0000; } 
        .btn-add { background-color: #34c759; }    

        /* ロックスイッチのデザイン */
        .lock-switch { display: flex; align-items: center; font-size: 12px; color: #333; background: #eee; padding: 5px 10px; border-radius: 20px; white-space: nowrap;}
        .lock-switch input { margin-right: 5px; transform: scale(1.2); }

        .tabs-container { display: flex; background-color: #e5e5ea; padding: 5px 5px 0 5px; overflow-x: auto; border-bottom: 1px solid #ccc; }
        .tab { background-color: #d1d1d6; padding: 8px 15px; margin-right: 4px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; display: flex; align-items: center; max-width: 200px; white-space: nowrap; user-select: none; }
        .tab.active { background-color: #ffffff; color: #000; font-weight: bold; }
        .tab-title { overflow: hidden; text-overflow: ellipsis; margin-right: 8px; }
        .close-tab { width: 16px; height: 16px; border-radius: 50%; background: #999; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0.7; }
        .close-tab:hover { background: #ff3b30; opacity: 1; }
        
        .content-area { flex-grow: 1; position: relative; background-color: white; }
        iframe { width: 100%; height: 100%; border: none; display: none; }
        iframe.active { display: block; }
        .welcome-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666; width: 80%; line-height: 1.6; }
    </style>
</head>
<body>

    <div class="control-bar">
        <input type="text" id="url-input" placeholder="検索ワード または URL">
        
        <button class="btn-google" onclick="execGoogle()">Google/URL</button>
        <button class="btn-youtube" onclick="execYoutube()">YouTube</button>
        <button class="btn-add" onclick="addNewTab()">＋ 新規</button>
        
        <!-- 乗っ取り防止スイッチ -->
        <label class="lock-switch">
            <input type="checkbox" id="hijack-blocker" checked>
            ロック有効
        </label>
    </div>

    <div class="tabs-container" id="tabs-list"></div>

    <div class="content-area" id="frames-container">
        <div class="welcome-msg">
            <h3>Web in Web (タブレット版)</h3>
            <p>
                <b>【重要：ロック機能について】</b><br>
                右上の「ロック有効」にチェックが入っていると、<br>
                検索時やリンククリック時に<br>
                <span style="color:red; font-weight:bold;">「このページを離れますか？」</span><br>
                という警告が出ることがあります。<br>
                <br>
                その場合は必ず<br>
                <span style="background:red; color:white; padding:2px 5px;">キャンセル</span><br>
                を押してください。そうすればタブ内で表示されます。
            </p>
        </div>
    </div>

    <script>
        let tabCount = 0;
        let activeTabId = null;

        // ■■■ ページ離脱防止機能（ここが重要） ■■■
        // 画面全体が切り替わろうとした時に警告を出す
        window.addEventListener('beforeunload', function (e) {
            const locker = document.getElementById('hijack-blocker');
            if (locker && locker.checked) {
                // 標準的なメッセージ表示（ブラウザにより文言は異なります）
                e.preventDefault();
                e.returnValue = ''; 
            }
        });

        function addNewTab() {
            tabCount++;
            const tabId = `tab-${tabCount}`;
            
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.id = `btn-${tabId}`;
            tabElement.innerHTML = `<span class="tab-title">新規タブ</span><span class="close-tab" onclick="closeTab('${tabId}', event)">✕</span>`;
            tabElement.onclick = () => switchTab(tabId);
            
            const iframeElement = document.createElement('iframe');
            iframeElement.id = `frame-${tabId}`;
            
            // sandbox属性：さらに制限を厳しくしました
            // allow-popups や allow-modals を削除し、allow-presentationも削除
            iframeElement.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');

            document.getElementById('tabs-list').appendChild(tabElement);
            document.getElementById('frames-container').appendChild(iframeElement);

            switchTab(tabId);
            const msg = document.querySelector('.welcome-msg');
            if(msg) msg.style.display = 'none';
        }

        function switchTab(tabId) {
            activeTabId = tabId;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('iframe').forEach(f => f.classList.remove('active'));

            const targetTab = document.getElementById(`btn-${tabId}`);
            const targetFrame = document.getElementById(`frame-${tabId}`);
            
            if (targetTab && targetFrame) {
                targetTab.classList.add('active');
                targetFrame.classList.add('active');
                const currentSrc = targetFrame.getAttribute('data-original-input') || '';
                document.getElementById('url-input').value = currentSrc;
            }
        }

        function closeTab(tabId, event) {
            event.stopPropagation();
            const tabBtn = document.getElementById(`btn-${tabId}`);
            const tabFrame = document.getElementById(`frame-${tabId}`);
            if (tabBtn) tabBtn.remove();
            if (tabFrame) tabFrame.remove();

            if (activeTabId === tabId) {
                const remainingTabs = document.querySelectorAll('.tab');
                if (remainingTabs.length > 0) {
                    const nextTabId = remainingTabs[remainingTabs.length - 1].id.replace('btn-', '');
                    switchTab(nextTabId);
                } else {
                    activeTabId = null;
                    document.querySelector('.welcome-msg').style.display = 'block';
                    document.getElementById('url-input').value = '';
                }
            }
        }

        function execGoogle() {
            if (!checkTab()) return;
            let input = document.getElementById('url-input').value.trim();
            if (!input) return;

            let url = "";
            if (input.startsWith('http://') || input.startsWith('https://') || (input.includes('.') && !input.includes(' '))) {
                url = input;
                if (!url.startsWith('http')) url = 'https://' + url;
                if (url.includes('youtube.com/watch') || url.includes('youtu.be/')) {
                    url = convertYoutubeLink(url);
                }
            } else {
                // Bing検索に変更（Googleよりタブレットでのiframe耐性が高いため）
                // Googleを使いたい場合はここを書き換えてください
                url = 'https://www.bing.com/search?q=' + encodeURIComponent(input);
            }
            updateFrame(url, input);
        }

        function execYoutube() {
            if (!checkTab()) return;
            let input = document.getElementById('url-input').value.trim();
            if (!input) return;
            let url = `https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(input)}`;
            updateFrame(url, "[YouTube] " + input);
        }

        function updateFrame(url, titleText) {
            const targetFrame = document.getElementById(`frame-${activeTabId}`);
            const targetTabTitle = document.querySelector(`#btn-${activeTabId} .tab-title`);
            
            targetFrame.src = url;
            targetFrame.setAttribute('data-original-input', document.getElementById('url-input').value);
            targetTabTitle.innerText = titleText;
        }

        function checkTab() {
            if (!activeTabId) {
                alert("まずは「新規タブ」を作成してください。");
                return false;
            }
            return true;
        }

        function convertYoutubeLink(url) {
            let videoId = "";
            if (url.includes('v=')) {
                videoId = url.split('v=')[1].split('&')[0];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            }
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            return url;
        }

        document.getElementById('url-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') execGoogle();
        });
    </script>
</body>
</html>
